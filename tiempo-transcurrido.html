<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <title>EBECO — Tiempo transcurrido</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body class="app">
    <main class="screen">
      <!-- Topbar -->
      <header class="topbar" role="banner">
        <button
          class="btn btn--ghost"
          onclick="history.back()"
          aria-label="Volver"
        >
          ←
        </button>
        <h1 class="topbar__title" style="flex: 1">EBECO</h1>
        <img
          src="assets/logo-ebeco.png"
          alt="Logo EBECO"
          class="brand__logo"
          style="
            width: 80px;
            height: 80px;
            object-fit: contain;
            border-radius: 50%;
            background: transparent;
            box-shadow: none;
          "
        />
      </header>

      <!-- Card principal con tiempo transcurrido y precio -->
      <section class="card u-grid stack-top" aria-labelledby="time-title">
        <h2 id="time-title">Tiempo transcurrido</h2>

        <!-- Hora de llegada y hora actual -->
        <div class="u-grid" style="text-align: center">
          <div class="status-item">
            <span class="status-label">Hora de llegada</span>
            <strong class="status-value" id="arrival-time">Cargando...</strong>
          </div>
          <div class="status-item">
            <span class="status-label">Hora actual</span>
            <strong class="status-value" id="current-time">Cargando...</strong>
          </div>
        </div>

        <!-- Tiempo transcurrido y costo total -->
        <div class="u-grid" style="text-align: center">
          <div class="status-item">
            <span class="status-label">Tiempo transcurrido</span>
            <strong class="status-value" id="elapsed-time">00:00:00</strong>
          </div>
          <div class="status-item">
            <span class="status-label">Total a pagar</span>
            <strong class="status-value" id="total-amount">S/. 0.00</strong>
          </div>
        </div>

        <!-- Botón de pagar -->
        <div class="actions">
          <a class="btn btn--primary btn--lg" href="bicicleta-desbloqueada.html"
            >Liberar bicicleta</a
          >
        </div>
      </section>
    </main>

    <script>
      // Función para actualizar la hora de llegada, hora actual, tiempo transcurrido y total a pagar
      const arrivalTime = new Date();
      let startTime = new Date(arrivalTime);
      let elapsedTime = 0; // en segundos
      let costPerHour = 3; // S/. 3 por hora

      function formatTime(seconds) {
        const hours = String(Math.floor(seconds / 3600)).padStart(2, "0");
        const minutes = String(Math.floor((seconds % 3600) / 60)).padStart(
          2,
          "0"
        );
        const secondsFormatted = String(seconds % 60).padStart(2, "0");
        return `${hours}:${minutes}:${secondsFormatted}`;
      }

      function updateDisplay() {
        const currentTime = new Date();
        elapsedTime = Math.floor((currentTime - startTime) / 1000); // en segundos
        const totalAmount = (
          Math.ceil(elapsedTime / 3600) * costPerHour
        ).toFixed(2);

        document.getElementById("arrival-time").textContent =
          startTime.toLocaleTimeString();
        document.getElementById("current-time").textContent =
          currentTime.toLocaleTimeString();
        document.getElementById("elapsed-time").textContent =
          formatTime(elapsedTime);
        document.getElementById(
          "total-amount"
        ).textContent = `S/. ${totalAmount}`;
      }

      // Actualiza cada segundo
      setInterval(updateDisplay, 1000);
      updateDisplay(); // Llamada inicial
    </script>
  </body>

  <!-- Utilitario de historial (mismo formato que en otras páginas) -->
  <script>
    window.EBECO = window.EBECO || {};
    (function () {
      const KEY = "ebeco-history";
      function load() {
        try {
          return JSON.parse(localStorage.getItem(KEY) || "[]");
        } catch {
          return [];
        }
      }
      function save(list) {
        localStorage.setItem(KEY, JSON.stringify(list));
      }
      function add({
        type,
        place,
        at = new Date().toISOString(),
        amount = null,
      }) {
        const list = load();
        list.unshift({
          id: crypto?.randomUUID
            ? crypto.randomUUID()
            : Date.now() + "-" + Math.random(),
          type, // 'estacionar' | 'liberar'
          place: place || "Sede desconocida",
          at, // ISO string
          amount, // número en soles o null
        });
        save(list.slice(0, 200)); // guarda máx. 200
      }
      function get() {
        return load();
      }
      function clear() {
        save([]);
      }
      EBECO.History = { add, get, clear };
    })();

    // Helpers comunes
    function getPlaceContext() {
      const params = new URLSearchParams(location.search);
      if (params.get("place")) return params.get("place");
      const cached = localStorage.getItem("ebeco-place");
      if (cached) return cached;
      return "Módulo A — UCSM"; // fallback
    }

    // Helper para leer el monto numérico desde "Total a pagar"
    function getAmountNumberFromLabel() {
      const raw =
        document.getElementById("total-amount")?.textContent || "S/. 0.00";
      const num = parseFloat(raw.replace(/[^\d.,-]/g, "").replace(",", "."));
      return isNaN(num) ? 0 : num;
    }
  </script>

  <script>
    let port2 = null;
    let writer2 = null;
    let isOpening2 = false;

    async function conectarArduino() {
      if (!("serial" in navigator)) {
        alert("Tu navegador no soporta Web Serial. Usa Chrome o Edge.");
        return false;
      }

      if (isOpening2) return false;
      isOpening2 = true;

      try {
        // Solicita puerto si aún no existe
        if (!port2) {
          port2 = await navigator.serial.requestPort();
          await port2.open({ baudRate: 115200 });
          writer2 = port2.writable.getWriter();
        }
        return true;
      } catch (e) {
        console.error("Error conectando Arduino:", e);
        alert("No se pudo conectar con el Arduino.");
        return false;
      } finally {
        isOpening2 = false;
      }
    }

    async function enviarUnlock() {
      try {
        if (!writer2) return;
        const data = new TextEncoder().encode("UNLOCK\n");
        await writer2.write(data);
        console.log("Comando UNLOCK enviado");
      } catch (err) {
        console.error("Error enviando UNLOCK:", err);
      }
    }

    // Interceptar click del botón "Liberar bicicleta"
    document
      .querySelector("a[href='bicicleta-desbloqueada.html']")
      .addEventListener("click", async (e) => {
        e.preventDefault(); // Detiene navegación inmediata

        // 1) Guardar en historial la liberación con el monto calculado
        try {
          window.EBECO?.History?.add({
            type: "liberar",
            place: getPlaceContext(),
            amount: getAmountNumberFromLabel(), // usa el "Total a pagar"
          });
        } catch (err) {
          console.warn("No se pudo registrar el historial (liberar):", err);
        }

        // 2) Enviar comando UNLOCK al Arduino (si se puede)
        const ok = await conectarArduino();
        if (ok) {
          await enviarUnlock();
        }

        // 3) Navegar a la pantalla de bicicleta desbloqueada
        setTimeout(() => {
          window.location.href = "bicicleta-desbloqueada.html";
        }, 500); // espera breve para que el comando salga
      });
  </script>
</html>
